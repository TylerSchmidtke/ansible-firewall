#!/bin/bash
##
# iptables rules generated by Ansible for {{ ansible_fqdn }}
# Do not modify by hand

{% if iptables_flush_all %}
# Clean all, set the default policy to ACCEPT briefly to prevent lockout
iptables -P INPUT ACCEPT
iptables -P OUTPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X
{% endif %}

# Accept all from localhost
iptables -A INPUT -i lo -j ACCEPT

{% if iptables_allow_icmp %}
# Accept icmp ping requests
iptables -A INPUT -p icmp  --icmp-type echo-request -j ACCEPT
iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT
{% endif %}

# Allow NTP traffic for time synchronization
iptables -A OUTPUT -p udp --dport 123 -j ACCEPT
iptables -A INPUT -p udp --sport 123 -j ACCEPT

# Allow DNS traffic for name resolution
iptables -A OUTPUT -p udp --dport 53 -j ACCEPT

# Allowed host rules
{% for rule in iptables_allowed_host_rules %}
iptables -A {{ rule.chain | default('INPUT') }} -p {{ rule.protocol | default('tcp') }} -s {{ rule.host }} --match multiport --dports {{ rule.ports|join(',') }} -j {{ rule.action | default('ACCEPT') }}
{% endfor %}

# Allowed group rules
{% for rule in iptables_allowed_group_rules %}
{% for host in groups[rule.group] %}
iptables -A {{ rule.chain | default('INPUT') }} -p {{ rule.protocol | default('tcp') }} -s {{ host }} --match multiport --dports {{ rule.ports|join(',') }} -j {{ rule.action | default('ACCEPT') }}
{% endfor %}
{% endfor %}

# Allowed ports
{% for rule in iptables_allowed_ports %}
iptables -A {{ rule.chain | default('INPUT') }} -p {{ rule.protocol | default('tcp') }} --dports {{ rule.ports|join(',') }} -j ACCEPT
{% endfor %}

# Allow establishedand related connections
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

{% if iptables_logging %}
# Logging
iptables -A INPUT -m limit --limit 15/minute -j LOG --log-level 7 --log-prefix "Dropped by iptables: "
{% endif %}

{% if iptables_input_deny_all %}
# Default deny input
iptables -P INPUT DROP
{% else %}
# Default allow input
iptables -P INPUT ACCEPT
{% endif %}

{% if iptables_forward_deny_all %}
# Default deny forward
iptables -P FORWARD DROP
{% else %}
# Default allow forward
iptables -P FORWARD ACCEPT
{% endif %}

{% if iptables_output_deny_all %}
# Default deny output
iptables -P OUTPUT DROP
{% else %}
iptables -P OUTPUT ACCEPT
{% endif %}
